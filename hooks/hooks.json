{
  "hooks": {
    "SubagentStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=SubagentStart",
            "async": true,
            "timeout": 5
          }
        ]
      }
    ],
    "SubagentStop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=SubagentStop",
            "async": true,
            "timeout": 5
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/security-check.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/deny-check.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/agent-tool-guard.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/budget-guard.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: budget-guard\ndescription: Track turn usage against budget limits and warn at 80%, block at 100%\nevent: PreToolUse\n---\n\n# Budget Guard\n\n**Runs BEFORE every tool use. Enforces budget limits when configured.**\n\n## Logic\n\n1. Find `.shinchan-docs/*/WORKFLOW_STATE.yaml` (use most recent if multiple)\n2. If NOT found ‚Üí ALLOW (no active workflow)\n3. Parse the `budget` section from the workflow state\n4. If NO `budget` section exists ‚Üí ALLOW (budget not configured, backward compatible)\n5. Read `.shinchan-docs/work-tracker.jsonl` and count events for current session\n6. Read current session ID from `.shinchan-docs/.session-id`\n7. Compare turn count against budget limits\n\n## Budget Section Format\n\nThe `budget` section in WORKFLOW_STATE.yaml:\n\n```yaml\nbudget:\n  total: 200        # Max turns for entire workflow\n  phase: 50         # Max turns for current phase\n  used_total: 0     # Accumulated total (updated by session-wrap)\n  used_phase: 0     # Accumulated for current phase (updated by session-wrap)\n  hard_limit: false  # true = REFUSE at 100%, false = WARN only (default)\n```\n\n## Turn Counting\n\nA \"turn\" is approximated by counting events in `.shinchan-docs/work-tracker.jsonl` where:\n- `session` matches the current session ID (from `.shinchan-docs/.session-id`)\n- `type` is one of: `tool_use`, `file_change`, `delegation`\n\nCurrent session turns are added to `used_total` and `used_phase` from the YAML.\n\n## Thresholds\n\nCalculate effective usage:\n\n```\neffective_total = budget.used_total + current_session_turns\neffective_phase = budget.used_phase + current_session_turns\ntotal_pct = (effective_total / budget.total) * 100\nphase_pct = (effective_phase / budget.phase) * 100\n```\n\nUse the HIGHER of `total_pct` and `phase_pct` for threshold checks.\n\n### At 80% (WARNING)\n\nIf either `total_pct >= 80` or `phase_pct >= 80` (but neither >= 100):\n\n**Action**: WARN with message:\n```\nBUDGET WARNING: Approaching limit.\n  Total: {effective_total}/{budget.total} turns ({total_pct}%)\n  Phase: {effective_phase}/{budget.phase} turns ({phase_pct}%)\n  Remaining: ~{remaining} turns before limit.\nPrioritize completing current task. Consider saving progress.\n```\n\nWhere `remaining` = minimum of `(budget.total - effective_total)` and `(budget.phase - effective_phase)`.\n\n### At 100% (EXCEEDED)\n\nIf either `total_pct >= 100` or `phase_pct >= 100`:\n\n**Check `hard_limit`**: Read the `budget.hard_limit` field from WORKFLOW_STATE.yaml.\n\n**If `hard_limit: true`**:\n\n**Action**: REFUSE with message:\n```\nBUDGET HARD STOP: Turn limit reached (hard_limit enabled).\n  Total: {effective_total}/{budget.total} turns ({total_pct}%)\n  Phase: {effective_phase}/{budget.phase} turns ({phase_pct}%)\nNo further operations allowed. Save state and stop immediately.\nException: Read/Write to .shinchan-docs/** paths are still allowed for state saving.\nUse /team-shinchan:budget --reset to continue.\n```\n\n**If `hard_limit: false` or not set** (default ‚Äî backward compatible):\n\n**Action**: WARN with message:\n```\nBUDGET EXCEEDED: Turn limit reached.\n  Total: {effective_total}/{budget.total} turns ({total_pct}%)\n  Phase: {effective_phase}/{budget.phase} turns ({phase_pct}%)\nACTION REQUIRED: Save current state to WORKFLOW_STATE.yaml and PROGRESS.md, then stop.\nUse /team-shinchan:budget --reset to start a new budget cycle if needed.\n```\n\n## Priority\n\nBudget guard runs AFTER security-check and deny-check (security takes precedence). When `hard_limit: false` (default), budget warnings are advisory. When `hard_limit: true`, the budget guard REFUSES tool calls at 100%.\n\n## Error Handling\n\n- Missing `.session-id` file ‚Üí assume 0 current session turns, ALLOW\n- Missing `work-tracker.jsonl` ‚Üí assume 0 current session turns, ALLOW\n- Malformed budget section ‚Üí skip budget check, ALLOW\n- Budget values of 0 or negative ‚Üí skip budget check, ALLOW\n"
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/workflow-guard.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: workflow-guard\ndescription: Enforce workflow stage rules by checking WORKFLOW_STATE.yaml before tool use\nevent: PreToolUse\n---\n\n# Workflow Guard\n<!-- Hard Guardrail Matrix ‚Äî Architectural Constraint -->\n\n**Runs BEFORE every tool use. Enforces stage restrictions.**\n\n## Logic\n\n1. Find `.shinchan-docs/*/WORKFLOW_STATE.yaml` (use most recent if multiple)\n2. If NOT found ‚Üí ALLOW (no active workflow)\n3. Parse `current.stage` ‚Üí check matrix below ‚Üí BLOCK or ALLOW\n\n## Stage-Tool Matrix\n\n| Tool | requirements | planning | execution | completion |\n|------|:---:|:---:|:---:|:---:|\n| Read/Glob/Grep/Task | OK | OK | OK | OK |\n| AskUserQuestion | OK | OK | OK | BLOCK |\n| Edit | BLOCK | BLOCK | OK | BLOCK |\n| Write | BLOCK* | BLOCK | OK | docs only** |\n| TodoWrite | BLOCK | BLOCK | OK | BLOCK |\n| Bash | BLOCK | BLOCK | OK | BLOCK |\n\n## Exceptions (ALWAYS ALLOWED regardless of stage)\n\n- **Write/Edit to `.shinchan-docs/`** ‚Äî workflow state, interview docs, REQUESTS.md, PROGRESS.md, WORKFLOW_STATE.yaml\n- **Bash `mkdir -p .shinchan-docs/`** ‚Äî creating workflow folders\n\nThese exceptions exist because `.shinchan-docs/` is workflow infrastructure, not project code.\n\n## Absolute Rule\n\nIn requirements/planning: Edit, Write, Bash, TodoWrite targeting **project code** = **BLOCK.**\n`.shinchan-docs/` writes are exempt (see Exceptions above).\n\n## Stage 1 Interpretation Guard\n\nUser requests like \"do X\", \"add feature\" ‚Üí add to REQUESTS.md, never implement.\n\n## Block Message\n\n`BLOCKED. Stage: {stage}. Tool: {tool} FORBIDDEN. Return to {stage}-appropriate action.`\n\n## Advancement Conditions\n\n- **requirements**: REQUESTS.md + Problem Statement + AC + User approval\n- **planning**: PROGRESS.md + Phase breakdown + per-phase AC\n- **completion**: RETROSPECTIVE.md + IMPLEMENTATION.md + Final review\n\n## Error Handling\n\nState file missing/corrupt/invalid ‚Üí default to \"requirements\" stage, warn user.\nSuggest: `/team-shinchan:resume` or `/team-shinchan:start`\n"
          }
        ]
      },
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/transition-gate.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/transition-gate.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/layer-guard.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/commit-lint.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: coding-reminder\ndescription: Remind coding principles before code modifications\nevent: PreToolUse\n---\n\nBefore this change, verify:\n1. Assumptions stated? Scope clear?\n2. Minimum code needed? No unnecessary abstractions?\n3. ONLY changing what was requested? No adjacent \"improvements\"?\n4. Success criteria defined? Verification plan?\n\n## Rules Reference\nBefore modifying code, also review applicable rules:\n- Coding rules: `${CLAUDE_PLUGIN_ROOT}/rules/coding.md`\n- Security rules: `${CLAUDE_PLUGIN_ROOT}/rules/security.md`\n- For git operations, also review: `${CLAUDE_PLUGIN_ROOT}/rules/git.md`\n"
          }
        ]
      },
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: coding-reminder\ndescription: Remind coding principles before code modifications\nevent: PreToolUse\n---\n\nBefore this change, verify:\n1. Assumptions stated? Scope clear?\n2. Minimum code needed? No unnecessary abstractions?\n3. ONLY changing what was requested? No adjacent \"improvements\"?\n4. Success criteria defined? Verification plan?\n\n## Rules Reference\nBefore modifying code, also review applicable rules:\n- Coding rules: `${CLAUDE_PLUGIN_ROOT}/rules/coding.md`\n- Security rules: `${CLAUDE_PLUGIN_ROOT}/rules/security.md`\n- For git operations, also review: `${CLAUDE_PLUGIN_ROOT}/rules/git.md`\n"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=PostToolUse",
            "async": true,
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=PostToolUse",
            "async": true,
            "timeout": 5
          },
          {
            "type": "prompt",
            "prompt": "---\nname: change-tracker\ndescription: Remind to track changes after code modifications\nevent: PostToolUse\n---\n\n# Change Tracking Reminder\n\nYou just modified a file. Please record this change:\n\n1. **If PROGRESS.md exists** for the current workflow:\n   - Add an entry to the \"Change Log\" section of the current Phase\n   - Format: `- [{file}] {what changed} ‚Äî {why}`\n\n2. **If no active workflow**: Skip this step.\n\nKeep entries concise (1 line per change).\n\n3. **Ontology Reminder** (if `.shinchan-docs/ontology/ontology.json` exists):\n   - If a NEW file was created: Consider if it should be added as a Component entity\n   - If an EXISTING file was significantly refactored (renamed exports, changed class structure): The ontology may need updating\n   - Display: `üî¨ [Ontology] {file} modified ‚Äî ontology may need incremental update at next session start`\n   - Do NOT auto-update the ontology during editing ‚Äî the SessionStart hook handles this\n"
          }
        ]
      },
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=PostToolUse",
            "async": true,
            "timeout": 5
          },
          {
            "type": "prompt",
            "prompt": "---\nname: change-tracker\ndescription: Remind to track changes after code modifications\nevent: PostToolUse\n---\n\n# Change Tracking Reminder\n\nYou just modified a file. Please record this change:\n\n1. **If PROGRESS.md exists** for the current workflow:\n   - Add an entry to the \"Change Log\" section of the current Phase\n   - Format: `- [{file}] {what changed} ‚Äî {why}`\n\n2. **If no active workflow**: Skip this step.\n\nKeep entries concise (1 line per change).\n\n3. **Ontology Reminder** (if `.shinchan-docs/ontology/ontology.json` exists):\n   - If a NEW file was created: Consider if it should be added as a Component entity\n   - If an EXISTING file was significantly refactored (renamed exports, changed class structure): The ontology may need updating\n   - Display: `üî¨ [Ontology] {file} modified ‚Äî ontology may need incremental update at next session start`\n   - Do NOT auto-update the ontology during editing ‚Äî the SessionStart hook handles this\n"
          },
          {
            "type": "prompt",
            "prompt": "---\nname: auto-verify\ndescription: Auto-trigger verify-implementation when entering Completion stage\nevent: PostToolUse\n---\n\n# Auto-Verify Hook\n\n**Runs AFTER tool use. Auto-triggers verification on Completion stage entry.**\n\n## Trigger\n\nOnly fires when:\n- Tool = Write, File = `**/WORKFLOW_STATE.yaml`\n- `current.stage == \"completion\"` AND `history[-1].event == \"execution_completed\"`\n- Verification has NOT already run this session\n\n## Action\n\nWhen triggered:\n1. Set `already_verified_this_session = true`\n2. Announce: \"Auto-Verify: Execution complete! Running verification...\"\n3. Execute `/team-shinchan:verify-implementation`\n4. Update WORKFLOW_STATE.yaml history:\n\n**On success:**\n```yaml\n- event: verify_implementation_passed\n  agent: action_kamen\n  result: all_passed\n```\n\n**On failure:**\n```yaml\n- event: verify_implementation_failed\n  agent: action_kamen\n  result: issues_found\n  blocking: true\n```\n- If passed ‚Üí proceed to RETROSPECTIVE.md\n- If failed ‚Üí list issues, stay in execution\n\n## Completion Gate\n\n```yaml\ntransition_gates:\n  completion_to_done:\n    - retrospective_written: true\n    - implementation_doc_written: true\n    - action_kamen_review_passed: true\n    - verify_implementation_passed: true\n```\n\n## Skip Conditions\n\nDo NOT trigger if:\n- `current.stage` != \"completion\"\n- Already verified this session\n- Workflow status is \"paused\" or \"blocked\"\n- User used `--skip-verify` flag (logs `verify_skipped` event)\n\n## Error Handling\n\n- verify-implementation fails to run ‚Üí log error, warn user, don't block. Allow manual run.\n- No verify-* skills found ‚Üí treat as passed, suggest `/team-shinchan:manage-skills`.\n"
          },
          {
            "type": "prompt",
            "prompt": "# Version Consistency Check (Git R-13)\n\nIf you just modified `plugin.json`, `marketplace.json`, or `README.md`:\n- Verify ALL version references match across: `.claude-plugin/plugin.json`, `.claude-plugin/marketplace.json`, and `README.md` badge\n- If any version was changed, update ALL version references atomically\n"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=UserPromptSubmit",
            "async": true,
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/trace-init.sh\"",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: shinnosuke-orchestrate\ndescription: Shinnosuke orchestrates every user request through the integrated workflow\nevent: UserPromptSubmit\n---\n\n# Shinnosuke Orchestrator\n\nYou are **Shinnosuke**, the main orchestrator of Team-Shinchan.\n\n## Step 0: Active Workflow Check (CRITICAL ‚Äî ALWAYS FIRST)\n\nRead `.shinchan-docs/*/WORKFLOW_STATE.yaml` for `status: active`:\n\n### A. Active workflow exists\n\n**Always display current position:**\n```\n‚îÅ‚îÅ‚îÅ üìç Active: {DOC_ID} | Stage: {stage} | Phase: {phase} ‚îÅ‚îÅ‚îÅ\n```\n\nThen read the relevant doc:\n- **requirements**: Read REQUESTS.md ‚Üí Nene handles it. STOP. Do NOT reclassify.\n- **planning**: Read PROGRESS.md ‚Üí Nene handles it. STOP.\n- **execution**: Read PROGRESS.md ‚Üí find first incomplete phase ‚Üí delegate to appropriate agent.\n- **completion**: Masumi + ActionKamen handle it. STOP.\n\n**User's message is interpreted IN CONTEXT of the active workflow:**\n- \"Ïù¥Í±∞ Ìï¥Ï§ò\" / \"do this\" ‚Üí applies to current phase, NOT a new task\n- Simple questions about the task ‚Üí answer, then remind next step\n- Unrelated question ‚Üí answer briefly, then: `üìç ÎèåÏïÑÍ∞àÍπåÏöî? {stage} Stage, Phase {N} ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§.`\n- \"ÏÉà ÏûëÏóÖ\" / \"Îã§Î•∏ Í±∞\" / explicitly different task ‚Üí suggest `/start` to begin new workflow\n\n**NEVER classify a user message as \"Simple question\" or \"Quick fix\" when an active workflow exists.** The workflow is the context. Always return to it.\n\n### B. No active workflow\n\nProceed to Step 1 (classify request).\n\n## Step 1: Classify Request (only when NO active workflow)\n\n| Type | Action |\n|------|--------|\n| Simple question | Answer directly, no workflow |\n| Quick fix (‚â§3 files, no design decisions, clear fix) | Bo implements ‚Üí Action Kamen review, skip docs |\n| Standard task | Full 4-stage Workflow |\n| Complex/Multi-phase | Full Workflow + Debate |\n\n**Classification**: ‚â§3 files, no design decisions, clear fix ‚Üí Lite (Quick Fix). Otherwise ‚Üí Full.\n**Bo vs Specialists**: Domain-specific (React, API, CI/CD) ‚Üí specialist. General ‚Üí Bo.\n**Kazama**: Use /ralph for complex phases requiring 30+ min focused work.\n\n## Skill ‚Üí Agent Routing\n\n| Skill | Agent | Skill | Agent |\n|-------|-------|-------|-------|\n| /start, /autopilot, /resume, /ultrawork | shinnosuke | /plan | nene |\n| /ralph | kazama | /analyze | hiroshi |\n| /deepsearch | shiro+masumi | /debate | midori |\n| /review, /verify-implementation | actionkamen | /frontend | aichan |\n| /backend | bunta | /devops | masao |\n| /implement, /manage-skills | bo | /requirements | misae |\n| /vision | ume | /bigproject | himawari |\n| /research | masumi | | |\n\n**Domain routing**: Code exploration‚Üíshiro, Analysis‚Üíhiroshi, Planning‚Üínene, Code writing‚Üíbo, Frontend‚Üíaichan, Backend‚Üíbunta, Infra‚Üímasao, Verification‚Üíactionkamen\n\n## Step 2: Full Workflow Stages\n\n### Doc ID Generation\nCheck for issue ID in request/branch. If found: `ISSUE-{id}`. Otherwise: `{branch}-{NNN}`. Create `.shinchan-docs/{DOC_ID}/`.\n\n### Stage 1 - Requirements\n- Clear request ‚Üí Proceed. Unclear ‚Üí Nene interview OR Misae analysis.\n- 2+ approaches / architecture change / security ‚Üí Trigger Debate (Midori).\n- Create REQUESTS.md via Nene.\n\n### Stage 2 - Planning\nNene: phase breakdown + AC. Shiro: impact analysis. Create PROGRESS.md.\n\n### Stage 3 - Execution (per phase)\n**Îß§ PhaseÎßàÎã§ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌòÑÏû¨ ÏúÑÏπòÎ•º ÏïåÎ¶∞Îã§:**\n```\nüë¶ [Shinnosuke] Phase {N}/{total} ÏãúÏûë: {phase_title} ‚Üí {agent}ÏóêÍ≤å ÏúÑÏûÑ\n```\n1. Shiro ‚Üí impact analysis\n2. Design needed? ‚Üí Debate (Midori)\n3. Delegate: Frontend‚ÜíAichan, Backend‚ÜíBunta, DevOps‚ÜíMasao, General‚ÜíBo\n4. Action Kamen ‚Üí Review (MANDATORY)\n5. Update PROGRESS.md\n**Phase ÏôÑÎ£å ÌõÑ:**\n```\nüë¶ [Shinnosuke] Phase {N}/{total} ÏôÑÎ£å ‚úÖ ‚Üí Îã§Ïùå: {next_phase or \"Î¶¨Î∑∞\"}\n```\n\n### Stage 4 - Completion (auto-proceed, no user prompt)\n1. Masumi ‚Üí RETROSPECTIVE.md + IMPLEMENTATION.md\n2. Action Kamen ‚Üí Final verification\n3. Report completion\n\n## Layer Dependency Guard\n\nBefore delegating to any agent, check `agents/_shared/layer-map.json` (if it exists):\n\n1. Determine the **source agent's layer** (the agent performing the delegation)\n2. Determine the **target agent's layer** (the agent being delegated to)\n3. Check if the call is allowed per `allowed_calls` rules and `exceptions`\n4. If the call **violates** layer rules, include a WARNING in the output:\n   ```\n   ‚ö†Ô∏è LAYER WARNING: {source}({sourceLayer}) ‚Üí {target}({targetLayer}) is not in allowed_calls.\n   Proceeding anyway ‚Äî review layer-map.json if this delegation should be formalized.\n   ```\n5. If `layer-map.json` does not exist, skip this check entirely\n\nThis is advisory at the prompt level. Additionally, `hooks/layer-guard.sh` enforces layer rules as a hard block on Task calls ‚Äî violations are programmatically refused before the call executes.\n\n---\n\n## Debate Triggers\n\nTrigger: 2+ approaches, architecture change, breaking patterns, perf vs readability, security.\nSkip: Simple CRUD, clear bug fix, user already decided.\n"
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: correction-capture\ndescription: Detects user corrections and reminds to record learnings\nevent: UserPromptSubmit\n---\n\n# Correction Capture Hook\n\nScan the user's message for correction patterns:\n\n**Korean**: \"ÏïÑÎãàÏïº\", \"Í∑∏Í≤å ÏïÑÎãàÎùº\", \"Îã§Ïãú Ìï¥\", \"ÏûòÎ™ª\", \"Í∑∏Î†áÍ≤å ÎßêÍ≥†\", \"ÏïÑÎãåÎç∞\"\n**English**: \"wrong\", \"that's not what I\", \"no, I meant\", \"redo\", \"not like that\", \"I said\"\n**Japanese**: \"ÈÅï„ÅÜ\", \"„Åù„ÅÜ„Åò„ÇÉ„Å™„Åè„Å¶\", \"„ÇÑ„ÇäÁõ¥„Åó\"\n\nIf a correction pattern is detected:\n\n1. Acknowledge the correction immediately\n2. After fixing the issue, record what went wrong in `.shinchan-docs/learnings.md`:\n   - What was the mistake?\n   - What was the correct approach?\n   - How to avoid it next time?\n\nFormat for learnings entry:\n```\n### [Date] Correction: {brief description}\n- **Mistake**: {what went wrong}\n- **Correct**: {what should have been done}\n- **Prevention**: {how to avoid next time}\n```\n"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=Stop",
            "async": true,
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/session-wrap.sh\"",
            "timeout": 15
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: session-wrap\ndescription: Generate session summary from Work Tracker logs\nevent: Stop\n---\n\n# Session Wrap\n\n**Automatically generate a quantitative session summary at session end.**\n\n## When to Trigger\n\n- The work tracker log (`.shinchan-docs/work-tracker.jsonl`) exists and has entries for the current session\n- Skip if no tracker file exists or the file is empty\n\n## Process\n\n### 1. Read Session Data\n\n1. Read the current session ID from `.shinchan-docs/.session-id`\n   - If file does not exist, skip summary generation (no active session tracked)\n2. Read `.shinchan-docs/work-tracker.jsonl`\n   - Parse each line as JSON: `{\"ts\", \"type\", \"agent\", \"session\", \"data\"}`\n3. Filter events where `event.session` matches the current session ID\n   - If zero events match, skip summary generation\n\n### 2. Compute Metrics\n\nFrom the filtered session events, calculate:\n\n| Metric | How |\n|--------|-----|\n| **Duration** | First event `ts` to last event `ts`. Format as `{start} - {end} ({N} minutes)` |\n| **Agents invoked** | Count unique non-null `agent` values from `agent_start` events. Build `{agent: count}` map. |\n| **Files changed** | Count events where `type === \"file_change\"`. Deduplicate by `data.file` path. |\n| **Delegations** | Count events where `type === \"delegation\"`. |\n| **Events total** | Total count of all filtered events. |\n\n### 3. Build Agent Activity Table\n\nFor each unique agent seen in `agent_start` events:\n\n| Agent | Invocations | Last Action |\n|-------|-------------|-------------|\n| {agent} | {count of agent_start for this agent} | {summary of last event involving this agent} |\n\n### 4. Build Key Events List\n\nSelect up to 15 notable events (prioritize `agent_start`, `delegation`, `file_change`, `stop`; skip repetitive `tool_use`).\n\nFormat each as:\n```\n- {HH:MM}: {type} ‚Äî {brief description from data}\n```\n\n### 5. Determine Output Path\n\n- Check if an active workflow document exists: look for `.shinchan-docs/*/PROGRESS.md` files with `status: active` in frontmatter\n  - If found, extract the `doc_id` from the directory name. Output path: `.shinchan-docs/{doc_id}/SESSION_SUMMARY.md`\n- If no active workflow: Output path: `.shinchan-docs/SESSION_SUMMARY.md`\n\n### 6. Write Summary File\n\nWrite the summary to the determined output path using this template:\n\n```markdown\n# Session Summary\n- **Session**: {session_id}\n- **Duration**: {start_time} - {end_time} ({N} minutes)\n- **Agents invoked**: {count} ({agent: count, ...})\n- **Files changed**: {count}\n- **Delegations**: {count}\n- **Events total**: {count}\n\n## Agent Activity\n| Agent | Invocations | Last Action |\n|-------|-------------|-------------|\n| {agent} | {count} | {last event summary} |\n\n## Key Events\n- {HH:MM}: {type} - {description}\n```\n\n### 6b. Budget Status (conditional)\n\nIf the active workflow has a `budget` section in WORKFLOW_STATE.yaml, add a Budget Status section to the summary. If no budget section exists, skip this entirely.\n\n1. Read `budget.total`, `budget.phase`, `budget.used_total`, `budget.used_phase` from WORKFLOW_STATE.yaml\n2. Calculate session turns (same count as step 2 ‚Äî events where type is `tool_use`, `file_change`, or `delegation`)\n3. Calculate effective totals:\n   ```\n   effective_total = budget.used_total + session_turns\n   effective_phase = budget.used_phase + session_turns\n   ```\n4. Determine status for each: `On Track` (<80%), `WARNING` (80-99%), `EXCEEDED` (>=100%)\n5. Append to the summary template:\n\n```markdown\n## Budget Status\n| Metric | Used | Max | Pct | Status |\n|--------|------|-----|-----|--------|\n| Total turns | {effective_total} | {budget.total} | {pct}% | {status} |\n| Phase turns | {effective_phase} | {budget.phase} | {pct}% | {status} |\n\nSession turns: {session_turns}\n```\n\n6. Update WORKFLOW_STATE.yaml: set `budget.used_total = effective_total` and `budget.used_phase = effective_phase` to persist accumulated counts for the next session.\n\n### 7. Ontology Refresh\n\nIf file_change events exist AND `.shinchan-docs/ontology/ontology.json` exists, run:\n```bash\nnode ${CLAUDE_PLUGIN_ROOT}/src/ontology-scanner.js \"${PWD}\" --format json > /tmp/ont-rescan.json && \\\nnode ${CLAUDE_PLUGIN_ROOT}/src/ontology-engine.js merge /tmp/ont-rescan.json && \\\nnode ${CLAUDE_PLUGIN_ROOT}/src/ontology-engine.js gen-kb\n```\nAppend `Ontology: refreshed` to confirmation. Skip silently if either condition unmet.\n\n### 8. Confirm\n\nOutput a brief confirmation:\n```\n[Session Wrap] Summary saved to {output_path}\n  Duration: {N} minutes | Agents: {count} | Files: {count} | Events: {count}\n```\n\n## Rules\n\n- Do NOT fail if work-tracker.jsonl is missing or empty; silently skip\n- Do NOT modify the work-tracker.jsonl file\n- Overwrite any existing SESSION_SUMMARY.md (each session produces a fresh summary)\n- Keep the summary concise; the auto-retrospective hook will consume it next\n"
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: auto-retrospective\ndescription: Automatically reflect and learn after task completion\nevent: Stop\n---\n\n# Auto-Retrospective\n\n**After significant task completion, reflect and save learnings.**\n\n## When to Trigger\n\n- Task involved code changes (not just questions)\n- Task took 2+ agent delegations\n- Task involved debugging or problem-solving\n\n## Process\n\n### 0. Check Session Summary (if available)\n\nRead `.shinchan-docs/{doc_id}/SESSION_SUMMARY.md` or `.shinchan-docs/SESSION_SUMMARY.md` for quantitative data. Use agent counts, file changes, and duration to ground your retrospective in facts.\n\nIf a SESSION_SUMMARY.md exists, reference its metrics (duration, agent invocations, files changed, delegations) in your analysis below. If it does not exist, proceed without it.\n\n### 1. Analyze\n\nAnswer briefly: What was the task? What worked? What mistakes? What patterns? What would you change?\n\n### 2. Categorize\n\n| Category | Extract |\n|----------|---------|\n| `pattern` | Reusable code/architecture approaches |\n| `mistake` | Errors made and prevention |\n| `preference` | User preferences discovered |\n| `convention` | Project conventions found |\n| `insight` | Technical insights gained |\n\n### 3. Save to `.shinchan-docs/learnings.md`\n\nCreate file if missing with header: `# Team-Shinchan Learnings`\n\n**Format per entry:**\n```markdown\n### [{category}] {title}\n- **Date**: {YYYY-MM-DD}\n- **Source**: {DOC_ID}\n- **Confidence**: {high|medium|low}\n- **Tags**: {comma-separated}\n- **Insight**: {description}\n\n---\n```\n\n### 4. Output Summary\n\n```\n[Auto-Retrospective] Learnings saved:\n  - [{category}] {brief description}\nSaved to: .shinchan-docs/learnings.md\n```\n\n## Deduplication\n\nBefore appending:\n1. Read existing learnings.md\n2. If similar content exists (same tags + similar title) ‚Üí update confidence, skip duplicate\n3. If no duplicate ‚Üí append\n\n### 5. Agent Evaluation\n\nAfter completing the retrospective, rate each agent that was used in this session.\n\n**Ground-Truth Metrics**: Before scoring, run the following to get objective metrics:\n```bash\nnode ${CLAUDE_PLUGIN_ROOT}/src/eval-metrics.js .shinchan-docs/work-tracker.jsonl\n```\nUse the output (avg_duration_sec, file_changes, test_pass_rate, first_pass_rate) to calibrate your scores below. If the script is unavailable, proceed with observation-based scoring.\n\n**For each agent used**, score on 4 dimensions (1-5 scale):\n\n| Dimension | Description | Scale |\n|-----------|-------------|-------|\n| `correctness` | Code/result accuracy | 1=wrong, 5=flawless |\n| `efficiency` | Turns used vs outcome achieved | 1=wasteful, 5=optimal |\n| `compliance` | Rules/principles adherence rate | 1=ignored, 5=perfect |\n| `quality` | Code quality (review pass rate) | 1=poor, 5=excellent |\n\n**Process:**\n\n1. Identify all agents invoked in this session (from Session Summary or observation)\n2. For each agent, create an evaluation record\n3. Append each record as a single JSONL line to `.shinchan-docs/eval-history.jsonl`\n\n**JSONL format** (one line per agent, appended to file):\n```\n{\"ts\":\"2026-02-25T10:30:00.000Z\",\"agent\":\"bo\",\"doc_id\":\"main-031\",\"phase\":1,\"scores\":{\"correctness\":4,\"efficiency\":5,\"compliance\":4,\"quality\":4},\"ground_truth\":{\"avg_duration_sec\":45,\"file_changes\":3,\"test_pass_rate\":1.0,\"first_pass_rate\":0.8},\"notes\":\"Implemented all 6 sub-tasks accurately\"}\n```\n\nInclude `ground_truth` from eval-metrics.js output when available. If not available, omit the field.\n\n4. Create the file if it does not exist\n5. Use the current `doc_id` from the active workflow, or `\"session\"` if no workflow is active\n\n**Output:**\n```\n[Auto-Retrospective] Agent evaluations recorded:\n  - bo: correctness=4, efficiency=5, compliance=4, quality=4\n  - aichan: correctness=4, efficiency=4, compliance=5, quality=4\nSaved to: .shinchan-docs/eval-history.jsonl\n```\n\n## Rules\n\n- Never skip after meaningful tasks\n- Be specific, not vague\n- One clear insight per entry\n- Include enough context for future reference\n- Always record agent evaluations when agents were used\n"
          }
        ]
      }
    ],
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=SessionStart",
            "async": true,
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/session-init.sh\"",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/ontology-auto-build.sh\"",
            "timeout": 30
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: load-kb\ndescription: Load knowledge base, learnings, and detect interrupted workflows at session start\nevent: SessionStart\n---\n\n# Load Knowledge Base Hook\n\nAt session start, load KB summary, past learnings, and detect any interrupted workflows.\nLoading is **phase-aware**: when an active workflow exists, only relevant context is loaded.\n\n## Process\n\n### 0. Detect Active Workflow and Phase\n\n1. **Scan**: Check `.shinchan-docs/*/WORKFLOW_STATE.yaml` files.\n2. **Find**: The most recent file with `status: active`.\n3. **Extract**: `current.stage` and `current.phase` from the active workflow.\n4. If no active workflow ‚Üí load everything (full mode, backward compatible).\n\n### 1. Load KB Summary\n\n- **Skip if**: Stage is `execution` (not needed during coding).\n- Read `.shinchan-docs/kb-summary.md` if it exists.\n- Display: `üìö [Team-Shinchan] Knowledge Base loaded ({N} patterns, {M} decisions)`\n\n### 2. Load Learnings\n\n- Read `.shinchan-docs/learnings.md` if it exists.\n- **Stage-aware filtering**:\n  - `requirements`: Load only `convention` and `preference` categories\n  - `planning`: Load `pattern` and `convention` categories\n  - `execution`: Load `pattern` and `mistake` categories (most relevant to coding)\n  - `completion`: Load all categories\n  - No active workflow: Load all (last 20, high-confidence first)\n- Display top 5 items.\n\n### 3. Ontology Summary + GC\n\n1. Read `.shinchan-docs/ontology/ontology.json` if it exists.\n2. Run GC: `node ${CLAUDE_PLUGIN_ROOT}/src/ontology-engine.js gc` (cleans stale entities).\n3. The ontology status report is displayed by `ontology-auto-build.md` (runs after this hook). Do not duplicate it here.\n4. **KB Freshness**: If `kb-summary.md` is older than `ontology.json`, regenerate it:\n   - Run: `node ${CLAUDE_PLUGIN_ROOT}/src/ontology-engine.js gen-kb`\n\n### 4. Regression Alert\n\n- **Skip if**: Stage is `requirements` or `planning`.\n- Read `.shinchan-docs/eval-history.jsonl` if it exists.\n- Scan for regressions (moving average method).\n- Display if found: `!! [Team-Shinchan] Performance regression detected: Agent: {agent}`\n\n### 5. Detect Interrupted Workflows\n\n1. Check `.shinchan-docs/*/WORKFLOW_STATE.yaml` files.\n2. Filter: `status: active` (not the current one if resuming).\n3. Display if found:\n```\n‚ö†Ô∏è [Team-Shinchan] Interrupted workflow detected!\nüìÅ {doc_id}: Stage {stage}, Phase {phase}\n‚ñ∂Ô∏è Resume with: /team-shinchan:resume {doc_id}\n```\n\n### 6. Phase-Specific Context (Execution Only)\n\nIf stage is `execution` and a phase number is known:\n1. Read `.shinchan-docs/{doc_id}/PROGRESS.md`\n2. Extract only the `## Phase {N}` section's acceptance criteria\n3. Display: `üéØ Phase {N} AC: {brief summary}`\n4. This replaces loading the full KB during execution.\n\n## State Migration Check\n\nIf a WORKFLOW_STATE.yaml with `version:` (not `schema_version:`) is found:\n- Run: `node ${CLAUDE_PLUGIN_ROOT}/src/state-migrator.js migrate <path>`\n- Display: `üîÑ [State] Migrated workflow state to schema v2`\n\n## Execution Order\n\n1. Detect Active Workflow (first ‚Äî determines loading strategy)\n2. State Migration (if needed)\n3. KB Summary (conditional)\n4. Learnings (stage-filtered)\n5. Ontology Summary + GC (conditional)\n6. Regression Alert (conditional)\n7. Interrupted Workflows (last ‚Äî highest priority alert)\n8. Phase-Specific Context (execution only)\n\n## Graceful Degradation\n\n- All files are optional. Each step is independent.\n- If no active workflow ‚Üí full load (backward compatible).\n- Missing files ‚Üí skip silently.\n"
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "---\nname: ontology-auto-build\ndescription: Auto-build or update project ontology at session start\nevent: SessionStart\n---\n\n# Ontology Auto-Build ‚Äî MANDATORY\n\n**This is a BLOCKING requirement. Execute IMMEDIATELY at session start before doing anything else.**\n\n## EXECUTE THIS SINGLE COMMAND\n\nRun this Bash command right now:\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/hooks/ontology-auto-build.sh\n```\n\nThis command:\n1. Builds or updates `.shinchan-docs/ontology/ontology.json`\n2. Generates a health report\n3. Creates `.shinchan-docs/kb-summary.md`\n\n**Do NOT skip this step. Do NOT attempt to run individual node commands. Just run the single bash command above.**\n\nIf the command fails or the script is not found, report the error to the user and continue.\n"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/run.cjs\" \"${CLAUDE_PLUGIN_ROOT}/hooks/write-tracker.sh\" HOOK_EVENT=SessionEnd",
            "async": true,
            "timeout": 5
          }
        ]
      }
    ]
  }
}
