#!/usr/bin/env node
// AGENTS.md Generator — reads agent frontmatter + layer-map.json
// CLI: (no flag)→stdout | --write→file | --check→diff check
const fs = require('fs');
const path = require('path');

const ROOT = path.join(__dirname, '..');
const AGENTS_DIR = path.join(ROOT, 'agents');
const LAYER_MAP = path.join(AGENTS_DIR, '_shared', 'layer-map.json');
const OUTPUT = path.join(ROOT, 'AGENTS.md');

function parseFrontmatter(content) {
  const lines = content.split('\n');
  if (lines[0].trim() !== '---') return {};
  const meta = {};
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim() === '---') break;
    if (lines[i].startsWith('<') || lines[i].startsWith(' ')) continue;
    const m = lines[i].match(/^(\w+):\s*(.+)$/);
    if (m) {
      let val = m[2].trim();
      if (val.startsWith('[')) { try { val = JSON.parse(val); } catch (_) {} }
      meta[m[1]] = val;
    }
  }
  return meta;
}

function readAgents() {
  return fs.readdirSync(AGENTS_DIR)
    .filter(f => f.endsWith('.md'))
    .map(f => ({ ...parseFrontmatter(fs.readFileSync(path.join(AGENTS_DIR, f), 'utf-8')), _file: f.replace('.md', '') }))
    .filter(a => a.name);
}

function loadLayers() {
  const data = JSON.parse(fs.readFileSync(LAYER_MAP, 'utf-8'));
  const map = {};
  const layerList = [];
  for (const [name, agents] of Object.entries(data.layers)) {
    for (const a of agents) map[a] = name;
    layerList.push({ name, agents });
  }
  return { layers: layerList, agentLayer: map };
}

function shortDesc(d) {
  if (!d) return '-';
  const s = d.split(/[.!]/)[0];
  return s.length > 50 ? s.slice(0, 47) + '...' : s;
}

function fmtTools(t) {
  if (!t || !Array.isArray(t)) return '-';
  return t.length <= 3 ? t.join(', ') : t.slice(0, 3).join(', ') + '...';
}

function generate() {
  const agents = readAgents();
  const { layers, agentLayer } = loadLayers();
  const L = [];
  L.push('# AGENTS.md - Team-Shinchan Agent Map', '',
    '> Auto-generated by `src/gen-agents-map.js`. Do not edit manually.', '',
    '## Layer Architecture', '', '```');
  for (const ly of layers) {
    L.push(`  [${ly.name}]`);
    L.push(`    └─ ${ly.agents.join(', ')}`);
  }
  L.push('```', '', '## Agent Registry', '',
    '| Agent | Layer | Role | Model | Key Tools | Turns | Permission |',
    '|-------|-------|------|-------|-----------|-------|------------|');
  for (const a of agents) {
    L.push(`| ${a.name} | ${agentLayer[a.name] || '?'} | ${shortDesc(a.description)} | ${a.model || '-'} | ${fmtTools(a.tools)} | ${a.maxTurns || '-'} | ${a.permissionMode || '-'} |`);
  }
  L.push('', '## Call Flow', '', '```',
    '  User', '    ↓',
    '  [Orchestration] shinnosuke / himawari', '    ↓',
    '  [Planning]  nene, misae, midori', '    ↓',
    '  [Advisory]  hiroshi, actionkamen, masumi', '    ↓',
    '  [Execution] bo, aichan, bunta, masao, kazama', '    ↓',
    '  [Utility]   shiro (explore), ume (vision)',
    '```', '', '## Quick Reference', '',
    '| Task | Agent |', '|------|-------|',
    '| Multi-agent coordination | shinnosuke |',
    '| Large-scale project | himawari |',
    '| Requirements analysis | misae |',
    '| Implementation planning | nene |',
    '| Design decisions (debate) | midori |',
    '| Strategic advice / debug | hiroshi |',
    '| Code review | actionkamen |',
    '| Documentation search | masumi |',
    '| General coding | bo |',
    '| Frontend (React/Vue) | aichan |',
    '| Backend (API/DB) | bunta |',
    '| DevOps (CI/CD/Infra) | masao |',
    '| Deep work / refactoring | kazama |',
    '| Quick codebase search | shiro |',
    '| Image / PDF analysis | ume |');
  return L.join('\n') + '\n';
}

const flag = process.argv[2];
const content = generate();
if (flag === '--write') {
  fs.writeFileSync(OUTPUT, content, 'utf-8');
  console.log(`Wrote AGENTS.md (${content.split('\n').length} lines)`);
} else if (flag === '--check') {
  if (!fs.existsSync(OUTPUT)) { console.error('AGENTS.md not found. Run with --write first.'); process.exit(1); }
  if (fs.readFileSync(OUTPUT, 'utf-8') !== content) { console.error('AGENTS.md is out of date. Run: node src/gen-agents-map.js --write'); process.exit(1); }
  console.log('AGENTS.md is up to date.');
} else {
  process.stdout.write(content);
}
